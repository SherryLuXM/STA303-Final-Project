---
title: "Data preparation"
output:
  pdf_document: default
---

# Instructions

- You only need to submit the .Rmd of this file, not a PDF.

- You should __comment__ your code clearly to show what you've done to prepare the data.

- The purpose of this file is to use the data in the `data-raw` folder to create the data you will use in the report. The data you will use in the report should be saved in the `data` folder. It is good professional practice to make sure you're never directly modifying your raw data, but instead creating new datasets based on merges/manipulations that you need to reuse.

- Make sure you've taken a look at the hints for the web scraping and census API. 

- You may find the `write_rds()` function from the `readr` package helpful (it is loaded as part of the `tidyverse`).

- You do not need to keep the structure below.

# Set up

```{r, libraries}
library(tidyverse)
library(polite)
library(rvest)
library(haven)
library(cancensus)
```

# Loading client data

```{r}
cust_dev <- readRDS("data-raw/cust_dev.Rds")
cust_sleep <- readRDS("data-raw/cust_sleep.Rds")
customer <- readRDS("data-raw/customer.Rds")
device <- readRDS("data-raw/device.Rds")
```

# Getting external data

## Web scraping industry data

```{r}
url <- "https://fitnesstrackerinfohub.netlify.app"

target <- bow(url,
              user_agent = "sherryxiaoman.lu@mail.utoronto.ca for STA303/1002 final project",
              force = TRUE)
target

html <- scrape(target)

device_data <- html %>% 
  html_elements("table") %>% 
  html_table() %>% 
  pluck(1)

saveRDS(device_data, file = "data-raw/device_data.Rds")
```

# Census API

```{r}
## Simplify to only needed variables
options(cancensus.api_key = "CensusMapper_c35605992b233a54f504b09dcd8d5687",
        cancensus.cache_path = "cache")

regions <- list_census_regions(dataset = "CA16")

regions_filtered <-  regions %>% 
  filter(level == "CSD") %>% # CSD are Census Subdivision; it is a geographic level
  as_census_region_list()

census_data_csd <- get_census(dataset='CA16', regions = regions_filtered,
                          vectors=c("v_CA16_2397"),
                          level='CSD', geo_format = "sf")

median_income <- census_data_csd %>% 
  as_tibble() %>% 
  select(CSDuid = GeoUID, contains("median"), Population) %>% 
  mutate(CSDuid = parse_number(CSDuid)) %>% 
  rename(hhld_median_inc = 2)

saveRDS(median_income, file = "data-raw/median_income.Rds")
```

## Data Merge
```{r}
postcode <- readRDS("data-raw/postcode.Rds")
median_income <- readRDS("data-raw/median_income.Rds")
device_data <- readRDS("data-raw/device_data.Rds")
PC_mi <- left_join(postcode, median_income, by = "CSDuid")
colnames(PC_mi)[1] <- "postcode" # change column name "PC" to "postcode" to allow the left_join between customer and PC_mi
cust_mi <- left_join(customer, PC_mi, by = "postcode") # match customers to their geographical median income
mi_devid <- left_join(cust_mi, cust_dev, by = "cust_id") # add cust_dev to the data frame
head(cust_mi)
head(mi_devid) # there can be multiple customers using the same device
mi_line <- left_join(mi_devid, device, by = "dev_id") # add device information to the data frame
head(mi_line)
today <- as.Date("2022-04-07")
mi_line <- mutate(mi_line, age = as.numeric(difftime(today, dob, units = "weeks"))/52.25)
head(mi_line)
colnames(device_data)[1] <- "device_name" 
mi_line <- left_join(mi_line, device_data, by = "device_name")
head(mi_line)
mi_line <- subset(mi_line, select = -c(dob, postcode, line, CSDuid))
saveRDS(mi_line, file = "data-raw/full.Rds")
```
## Split the dataset
```{r}
mi_line <- readRDS("data-raw/full.Rds")
# remove duplicates, otherwise it would affect the mean and variance for different groups
mi_line <- mi_line[!duplicated(mi_line$cust_id),]
# split the dataset randomly
set.seed(2022303)
sample_size <- floor(0.7*nrow(mi_line))
picked <- sample(seq_len(nrow(mi_line)),size = sample_size)
train <- mi_line[picked,]
test <- mi_line[-picked,]
saveRDS(train, file = "data-raw/train.Rds")
saveRDS(test, file = "data-raw/test.Rds")
```

## dealing with duplicated customer IDs
```{r}
fullRds = readRDS("data-raw/full.Rds")
dup1 <- fullRds[duplicated(fullRds$cust_id),]
dup <- data.frame(matrix(
  vector(), 0, 21, dimnames=list(c(), colnames(fullRds))),
                stringsAsFactors=F)
for (i in dup1$cust_id){
  dup <- rbind(dup, fullRds[which(fullRds$cust_id == i),])
}
#view(dup)
saveRDS(dup, file = "data/duplicates.Rds")
```

## Data Preparation for Research Question 1
```{r}
marketing_question <- mi_line %>%
  select(c(cust_id, sex, emoji_modifier, hhld_median_inc, 
           Population, Recommended retail price)) %>%
  mutate(new_customer = if_else((Line == "Advance" | Line == "Active"), 1, 0), #create categorical to see who is a new customer
         age = as.numeric(difftime(Sys.Date(),full_clean$dob, units = "weeks"))/52.25) %>% #create an age column of the customer
  drop_na(emoji_modifier) %>% #drop all NA values for emoji_modifier
  drop_na(sex)  #drop all NA values for sex

marketing_question <- full[!duplicated(marketing_question$cust_id), ] # remove all duplicates, as there were multiple purchases per single customer (at different locations, violates independence of observations)
saveRDS(marketing_question, file = "data/marketing_question.Rds")
```
